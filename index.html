<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#000000" id="theme-color-meta">
    <meta name="apple-mobile-web-app-title" content="Nötes">
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="icon" type="image/png" href="assets/favicon-96x96.png" sizes="96x96">
    <link rel="shortcut icon" href="assets/favicon.ico">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    
    <!-- Android Chrome Icons -->
    <link rel="manifest" href="manifest.json">
    
    <title>Notes</title>
    <style>
        :root {
            /* Dark theme colors */
            --bg-color-dark: #000;
            --text-color-dark: #fff;
            --secondary-bg-dark: #1C1C1E;
            --secondary-text-dark: #666;
            
            /* Light theme colors */
            --bg-color-light: #fff;
            --text-color-light: #000;
            --secondary-bg-light: #f2f2f7;
            --secondary-text-light: #999;
            
            /* Theme-independent colors */
            --accent-color: #FFB800;
            --button-color: #007AFF;
        }

        * {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        body.light-mode {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: var(--bg-color-dark);
            display: flex;
            flex-direction: column;
        }

        body.light-mode #app {
            background-color: var(--bg-color-light);
        }

        .notes-title {
            color: var(--text-color-dark);
        }

        body.light-mode .notes-title {
            color: var(--text-color-light);
        }

        #text-overlay {
            color: var(--text-color-dark);
        }

        body.light-mode #text-overlay {
            color: var(--text-color-light);
        }

        .creation-time {
            color: var(--secondary-text-dark);
        }

        body.light-mode .creation-time {
            color: var(--secondary-text-light);
        }

        html, body {
            width: 100%;
            height: 100%;
            background-color: #000;
            overflow: hidden;
            touch-action: none;
        }

        #app {
            width: 100vw;
            height: 100vh;
            position: relative;
            background-color: #000;
            display: flex;
            flex-direction: column;
        }

        .header {
            display: flex;
            flex-direction: column;
            padding: 15px;
            padding-bottom: 0;
            color: #FFB800;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .creation-time {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 10px;
            font-weight: normal;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 17px;
        }

        .back-button::before {
            content: "‹";
            font-size: 32px;
            line-height: 20px;
        }

        .header-right {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .circle-button {
            width: 24px;
            height: 24px;
            border: 1.5px solid #FFB800;
            border-radius: 50%;
            background: none;
            color: #FFB800;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .circle-button.disabled {
            border-color: #666;
            color: #666;
            pointer-events: none;
        }

        .notes-title {
            color: white;
            font-size: 30px;
            font-weight: bold;
            margin-left: 5px;
            margin-bottom: 5px;
            outline: none;
            caret-color: #007AFF;
            -webkit-user-select: text;
            user-select: text;
        }

        #text-overlay {
            flex: 1;
            padding: 0 20px;
            margin-top: -5px;
            color: white;
            font-size: 16px;
            line-height: 1.5;
            outline: none;
            caret-color: #007AFF;
            -webkit-user-select: text;
            user-select: text;
            overflow-y: auto;
        }

        .toolbar {
            height: 85px;
            padding: 15px;
            padding-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .toolbar-button {
            width: 42px;
            height: 42px;
            background: none;
            border: none;
            color: #FFB800;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toolbar-button img {
            width: 42px;
            height: 42px;
            object-fit: contain;
        }

        .toolbar-button.disabled {
            pointer-events: none;
        }

        .home-indicator {
            width: 135px;
            height: 5px;
            background: white;
            border-radius: 100px;
            margin: 8px auto;
            position: relative;
            z-index: 1;
        }

        /* Settings Panel Styles */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100%;
            background-color: #000;
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background-color: #000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
        }

        .settings-title {
            font-size: 24px;
            font-weight: bold;
        }

        .close-settings {
            background: none;
            border: none;
            color: #007AFF;
            font-size: 17px;
        }

        .settings-group {
            margin-bottom: 25px;
        }

        .settings-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .settings-input {
            width: 100%;
            background: #1C1C1E;
            border: none;
            border-radius: 10px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-bottom: 15px;
        }

        .settings-textarea {
            height: 100px;
            resize: none;
        }

        #drawing-canvas {
            flex: 1;
            background: #000;
            touch-action: none;
            display: none;
        }

        .effect-settings {
            display: none;
        }

        .effect-settings.active {
            display: block;
        }

        #order-settings {
            display: block;
        }

        .drawing-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1C1C1E;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 2000;
            display: none;
        }

        .drawing-popup.active {
            display: block;
        }

        .drawing-popup input {
            width: 100%;
            background: #2C2C2E;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-bottom: 15px;
        }

        .drawing-popup button {
            width: 100%;
            background: #007AFF;
            border: none;
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 17px;
            margin-top: 10px;
        }

        .drawing-list {
            margin-top: 20px;
        }

        .drawing-item {
            background: #1C1C1E;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            position: relative;
        }

        .drawing-item-title {
            font-size: 17px;
            margin-bottom: 5px;
        }

        .drawing-item-keyword {
            font-size: 13px;
            color: #666;
        }

        .delete-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1C1C1E;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            z-index: 2000;
            display: none;
            text-align: center;
        }

        .delete-popup.active {
            display: block;
        }

        .delete-popup-title {
            font-size: 17px;
            margin-bottom: 20px;
            color: white;
        }

        .delete-popup-buttons {
            display: flex;
            gap: 10px;
        }

        .delete-popup-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .delete-popup-button.cancel {
            background: #2C2C2E;
            color: #007AFF;
        }

        .delete-popup-button.delete {
            background: #FF3B30;
            color: white;
        }

        .countdown {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 72px;
            color: #FFB800;
            z-index: 2000;
            display: none;
        }

        .countdown.active {
            display: block;
        }

        .drawing-popup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .drawing-popup-button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 17px;
            cursor: pointer;
        }

        .drawing-popup-button.cancel {
            background: #2C2C2E;
            color: #007AFF;
        }

        .drawing-popup-button.save {
            background: #007AFF;
            color: white;
        }

        .drawing-popup input {
            margin-bottom: 10px;
        }

        /* Numpad Styles */
        .numpad-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            width: 300px;
            z-index: 1000;
        }

        .numpad-display {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 24px;
            margin-bottom: 15px;
            border-radius: 8px;
            min-height: 30px;
        }

        .numpad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .numpad-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 15px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .numpad-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        #filtered-words {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
            color: white;
        }

        .word-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .word {
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
        }

        .lexicon-letters {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .lexicon-letter {
            background: rgba(255, 184, 0, 0.2);
            color: #FFB800;
            border: 1px solid #FFB800;
            padding: 5px 15px;
            border-radius: 5px;
            font-size: 18px;
            cursor: pointer;
        }

        /* Writing Settings Panel Styles */
        .writing-settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #FFB800;
            border-radius: 10px;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            z-index: 1000;
            color: white;
            display: none;
        }

        .writing-settings-panel h2 {
            color: #FFB800;
            margin-top: 0;
            text-align: center;
            margin-bottom: 20px;
        }

        .writing-settings-panel .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #FFB800;
            font-size: 20px;
            cursor: pointer;
        }

        /* Toggle Switch Styles */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 184, 0, 0.2);
        }

        .toggle-label {
            color: white;
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #FFB800;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Android-specific styles */
        body.android-mode {
            background-color: #202124;
            color: #e8eaed;
        }

        body.android-mode #app {
            display: none !important;
        }

        body.android-mode #android-ui {
            display: flex !important;
            flex-direction: column;
            height: 100vh;
            background-color: #202124;
            color: #e8eaed;
        }

        body.android-mode .header {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            height: 56px;
            background-color: #202124;
        }

        body.android-mode .note-content {
            flex: 1;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: #202124;
            overflow-y: auto;
            position: relative;
        }

        body.android-mode .note-content.free-will-mode {
            overflow-y: hidden;
        }

        body.android-mode .note-title,
        body.android-mode .note-body {
            font-size: 22px;
            font-weight: normal;
            background: transparent;
            border: none;
            color: #e8eaed;
            width: 100%;
            padding: 0;
            transition: transform 0.3s ease;
        }

        body.android-mode .note-body {
            font-size: 16px;
            flex: 1;
            resize: none;
        }

        body.android-mode .note-content.free-will-mode .note-title,
        body.android-mode .note-content.free-will-mode .note-body {
            position: relative;
            width: 100%;
            transform: none;
        }

        body.android-mode .note-content.free-will-mode .note-title {
            margin-bottom: 16px;
        }

        body.android-mode .note-content.free-will-mode .note-body {
            white-space: pre-wrap;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        body.android-mode .footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            height: 48px;
            background-color: #202124;
            margin-bottom: 16px;
            position: relative;
            bottom: 8px;
        }

        body.android-mode .footer-left {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        body.android-mode .footer-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
        }

        body.android-mode .header-icon,
        body.android-mode .footer-icon {
            width: 22px; /* Reduced from 24px */
            height: 22px; /* Reduced from 24px */
            cursor: pointer;
            opacity: 0.87;
        }

        body.android-mode .back-arrow {
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.87;
        }

        body.android-mode .header-actions {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        body.android-mode #drawing-canvas {
            position: absolute;
            top: 56px; /* Height of the header */
            left: 0;
            right: 0;
            bottom: 48px; /* Height of the footer */
            background: #202124;
            z-index: 1;
        }

        body.android-mode .numpad-container {
            background: rgba(32, 33, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.android-mode #filtered-words {
            background: rgba(32, 33, 36, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.android-mode .settings-panel {
            background: #202124;
        }

        body.android-mode .drawing-popup {
            background: #202124;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        body.android-mode .delete-popup {
            background: #202124;
            border: 1px solid rgba(255, 255, 255, 0.12);
        }

        /* Update Android UI note content area */
        body.android-mode .note-content {
            position: relative;
            flex: 1;
            overflow: hidden;
        }

        body.android-mode .settings-header {
            background-color: #202124;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <div class="header-top">
            <div class="header-left">
                <span class="back-button"></span>
                    <span id="mic-toggle" style="cursor: pointer;">All on My iPhone</span>
            </div>
            <div class="header-center">
                    <button class="circle-button disabled">↺</button>
                    <button class="circle-button disabled">↻</button>
            </div>
            <div class="header-right">
                    <button id="settings-button" style="background: none; border: none; padding: 0; margin: 0;">
                        <svg viewBox="0 0 24 24" width="22" height="22" fill="#FFB800">
                            <path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.11 0-2-.9-2-2V10c0-1.11.89-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .89 2 2z"/>
                        </svg>
                    </button>
                    <button id="start-mic" class="circle-button">⋯</button>
            </div>
            </div>
            <div class="creation-time">22 March 2025 at 11:35</div>
        </div>

        <div id="text-overlay" contenteditable="true" spellcheck="true">
            <h1 class="notes-title" contenteditable="true" spellcheck="true">Items</h1>
            <br><br>
            Infront of you are 4 items:
            <br><br>
            A phone<br>
            A watch<br>
            Airpods<br>
            A wallet
            <br><br>
            Place these items in any order you wish.
            <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>`;
        </div>

        <canvas id="drawing-canvas"></canvas>

        <div class="toolbar">
            <button class="toolbar-button disabled" id="checklist-btn">
                <img src="./images/toolbar-checklist.PNG" alt="Checklist">
                </button>
            <button class="toolbar-button disabled" id="paperclip-btn">
                <img src="./images/toolbar-paperclip.PNG" alt="Attach">
                </button>
            <button class="toolbar-button disabled" id="pen-btn">
                <img src="./images/toolbar-pen.PNG" alt="Draw">
                </button>
            <button class="toolbar-button disabled" id="writing-btn">
                <img src="./images/toolbar-writing.PNG" alt="Writing Tools">
                </button>
            <button class="toolbar-button" id="new-btn">
                <img src="./images/toolbar-new.PNG" alt="New Note">
                </button>
        </div>
        <div class="home-indicator"></div>
    </div>

    <div id="android-ui" style="display: none;">
        <div class="header">
            <img src="assets/android/back-arrow.svg" alt="Back" class="back-arrow">
            <div class="header-actions">
                <img src="assets/android/pin.svg" alt="Pin" class="header-icon">
                <img src="assets/android/bell.svg" alt="Reminder" class="header-icon">
                <img src="assets/android/archive.svg" alt="Archive" class="header-icon">
            </div>
        </div>

        <div class="note-content">
            <input type="text" class="note-title" placeholder="Title">
            <textarea class="note-body" placeholder="Note"></textarea>
        </div>

        <div class="footer">
            <div class="footer-left">
                <img src="assets/android/add.svg" alt="Add" class="footer-icon">
                <img src="assets/android/palette.svg" alt="Color" class="footer-icon">
            </div>
            <div class="footer-center">Edited 15:41</div>
            <img src="assets/android/more.svg" alt="More" class="footer-icon">
        </div>
    </div>

    <!-- Drawing Save Popup -->
    <div class="drawing-popup" id="drawing-popup">
        <input type="text" id="drawing-title" placeholder="Drawing Title">
        <input type="text" id="drawing-keyword" placeholder="Keyword">
        <div class="drawing-popup-buttons">
            <button class="drawing-popup-button cancel" id="cancel-drawing">Cancel</button>
            <button class="drawing-popup-button save" id="save-drawing">Save</button>
        </div>
    </div>

    <!-- Countdown Display -->
    <div class="countdown" id="countdown"></div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <div class="settings-title">Settings</div>
            <button class="close-settings" id="close-settings">Done</button>
        </div>
        
        <!-- Order Effect Settings -->
        <div class="effect-settings" id="order-settings">
            <div class="settings-group">
                <div class="settings-label">Microphone Start Delay (seconds)</div>
                <input type="number" class="settings-input" id="mic-delay" value="5" min="1" max="300">
            </div>
            <div class="settings-group">
                <div class="settings-label">Trigger Word</div>
                <input type="text" class="settings-input" id="trigger-word" value="perfect">
            </div>
            <div class="settings-group">
                <div class="settings-label">Response Template</div>
                <textarea class="settings-input settings-textarea" id="response-template">If I have influenced you correctly, you should've placed [ITEM 1] first, then [ITEM 2], followed by [ITEM 3] and finally, [ITEM 4]. How did I do?</textarea>
            </div>
        </div>

        <!-- Free Will Effect Settings -->
        <div class="effect-settings" id="freewill-settings">
            <div class="settings-group">
                <div class="settings-label">Items (one per line)</div>
                <textarea class="settings-input settings-textarea" id="freewill-items">A pen
A wallet
A watch</textarea>
            </div>
            <div class="settings-group">
                <div class="settings-label">Input Method</div>
                <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="freewill-input-method" value="columns" checked>
                        <span>Columns</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="radio" name="freewill-input-method" value="direction">
                        <span>Direction</span>
                    </label>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-label">Columns</div>
                <input type="number" class="settings-input" id="freewill-columns" value="3" min="2" max="10">
            </div>
            <div class="settings-group">
                <div class="settings-label">First Message</div>
                <textarea class="settings-input settings-textarea" id="freewill-first">Great. Now pick up another item and put it in your pocket.</textarea>
            </div>
            <div class="settings-group">
                <div class="settings-label">Second Message</div>
                <textarea class="settings-input settings-textarea" id="freewill-second">Perfect. And the last item, keep in your hands.</textarea>
            </div>
            <div class="settings-group">
                <div class="settings-label">Final Message Template</div>
                <textarea class="settings-input settings-textarea" id="freewill-final">If I have influenced you correctly, I should be holding the [FIRST], you should be holding the [LAST], and the [SECOND] should be in your pocket!</textarea>
            </div>
            <button class="save-settings" id="save-freewill">Save Changes</button>
        </div>

        <!-- Other Effect Settings (Coming Soon) -->
        <div class="effect-settings" id="other-settings">
            <div class="settings-group">
                <div class="settings-label">Updates Coming Soon</div>
                <p style="color: #666; margin-top: 10px;">New features and settings will be available in a future update.</p>
            </div>
        </div>

        <!-- Drawing Effect Settings -->
        <div class="effect-settings" id="drawing-settings">
            <div class="settings-group">
                <div class="settings-label">Saved Drawings</div>
                <div class="drawing-list" id="drawing-list">
                    <!-- Drawings will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Popup -->
    <div class="delete-popup" id="delete-popup">
        <div class="delete-popup-title">Delete Drawing?</div>
        <div class="delete-popup-buttons">
            <button class="delete-popup-button cancel" id="cancel-delete">Cancel</button>
            <button class="delete-popup-button delete" id="confirm-delete">Delete</button>
        </div>
    </div>

    <!-- Add a hidden input for dictation -->
    <input type="text" id="dictation-input" style="position: absolute; top: -9999px; left: -9999px; color: black; background: black; caret-color: transparent;">

    <!-- Add numpad HTML -->
    <div id="numpad-container" class="numpad-container">
        <div class="numpad-display" id="numpad-display"></div>
        <div class="numpad-grid">
            <button class="numpad-btn">1</button>
            <button class="numpad-btn">2</button>
            <button class="numpad-btn">3</button>
            <button class="numpad-btn">4</button>
            <button class="numpad-btn">5</button>
            <button class="numpad-btn">6</button>
            <button class="numpad-btn">7</button>
            <button class="numpad-btn">8</button>
            <button class="numpad-btn">9</button>
            <button class="numpad-btn backspace" style="font-size: 16px;">←</button>
            <button class="numpad-btn">0</button>
            <button class="numpad-btn" style="visibility: hidden;"></button>
        </div>
    </div>
    <div id="filtered-words"></div>

    <!-- Add Writing Settings Panel -->
    <div id="writing-settings" class="writing-settings-panel">
        <button class="close-btn" onclick="document.getElementById('writing-settings').style.display='none'">×</button>
        <h2>Writing Settings</h2>
        
        <!-- Theme Toggle -->
        <div class="toggle-container">
            <span class="toggle-label">Dark Mode</span>
            <label class="toggle-switch">
                <input type="checkbox" id="theme-toggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>

        <!-- Platform Toggle -->
        <div class="toggle-container">
            <span class="toggle-label">iOS Style</span>
            <label class="toggle-switch">
                <input type="checkbox" id="platform-toggle" checked>
                <span class="toggle-slider"></span>
            </label>
        </div>
    </div>

    <script>
        // Theme handling
        function initializeTheme() {
            // Check if user has a saved preference
            const savedTheme = localStorage.getItem('theme');
            
            // Default to dark mode unless user explicitly chose light mode before
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('theme-toggle').checked = false;
            } else {
                // Default to dark mode
                document.body.classList.remove('light-mode');
                document.getElementById('theme-toggle').checked = true;
                if (!savedTheme) {
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add theme toggle listener
            document.getElementById('theme-toggle').addEventListener('change', (e) => {
                const isDark = e.target.checked;
                document.body.classList.toggle('light-mode', !isDark);
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            // ... rest of the existing DOMContentLoaded code ...

            // Add double-click handlers for undo/redo buttons
            const undoButton = document.querySelector('.circle-button:first-child');
            const redoButton = document.querySelector('.circle-button:last-child');

            [undoButton, redoButton].forEach(button => {
                button.addEventListener('dblclick', () => {
                    if (currentEffect === 'writing') {
                        // Reset the Writing effect
                        currentCode = '';
                        const numpadDisplay = document.getElementById('numpad-display');
                        const numpadContainer = document.getElementById('numpad-container');
                        const filteredWordsContainer = document.getElementById('filtered-words');
                        
                        if (numpadDisplay) numpadDisplay.textContent = '';
                        if (numpadContainer) numpadContainer.style.display = 'block';
                        if (filteredWordsContainer) filteredWordsContainer.style.display = 'none';
                    }
                });
            });

            // Effect Button Listeners
            const effectButtons = {
                'checklist-btn': 'order',
                'new-btn': 'new',
                'paperclip-btn': 'paperclip',
                'pen-btn': 'pen',
                'writing-btn': 'writing'
            };

            // Add click listeners to effect buttons
            Object.entries(effectButtons).forEach(([buttonId, effect]) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    button.addEventListener('click', () => {
                        console.log('Button clicked:', buttonId, 'Effect:', effect); // Debug log
                        switchToEffect(effect);
                    });
                } else {
                    console.error('Button not found:', buttonId); // Debug log
                }
            });

            // Initialize with Free Will effect
            switchToEffect('new');
        });

        // Settings Panel Functionality
        const settingsButton = document.getElementById('settings-button');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettings = document.getElementById('close-settings');
        const micDelay = document.getElementById('mic-delay');
        const triggerWord = document.getElementById('trigger-word');
        const responseTemplate = document.getElementById('response-template');
        const textOverlay = document.getElementById('text-overlay');
        const drawingCanvas = document.getElementById('drawing-canvas');
        const notesTitle = document.querySelector('.notes-title');

        let currentEffect = 'new';

        // Add these at the top with other variables
        let currentDrawingData = null;
        let drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
        let isEditingDrawing = false;
        let editingDrawingId = null;
        const drawingPopup = document.getElementById('drawing-popup');
        const drawingTitle = document.getElementById('drawing-title');
        const drawingKeyword = document.getElementById('drawing-keyword');
        const saveDrawingBtn = document.getElementById('save-drawing');
        const countdownDisplay = document.getElementById('countdown');

        let drawingToDelete = null;
        const deletePopup = document.getElementById('delete-popup');
        const cancelDeleteBtn = document.getElementById('cancel-delete');
        const confirmDeleteBtn = document.getElementById('confirm-delete');
        let drawingPressTimer;
        let undoPressTimer;
        let drawingHistory = [];
        let currentHistoryIndex = -1;

        // Default drawings that will always be available
        const defaultDrawings = [
            // Original drawings
            {
                id: 'default-1',
                title: 'Cross',
                keyword: 'towards',
                imagePath: './images/drawings/cross.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-2',
                title: 'Square',
                keyword: 'fantastic',
                imagePath: './images/drawings/square.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-3',
                title: 'Circle',
                keyword: 'wonderful',
                imagePath: './images/drawings/circle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-4',
                title: 'Triangle',
                keyword: 'fair',
                imagePath: './images/drawings/triangle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-5',
                title: 'Waves',
                keyword: 'free',
                imagePath: './images/drawings/waves.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-6',
                title: 'Star',
                keyword: 'finally',
                imagePath: './images/drawings/star.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            // New drawings
            {
                id: 'default-7',
                title: 'Stickman',
                keyword: 'human',
                imagePath: './images/drawings/stickman.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-8',
                title: 'Smiley',
                keyword: 'happy',
                imagePath: './images/drawings/smiley.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-9',
                title: 'Heart',
                keyword: 'affectionate',
                imagePath: './images/drawings/heart.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-10',
                title: 'Boat',
                keyword: 'serene',
                imagePath: './images/drawings/boat.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-11',
                title: 'House',
                keyword: 'family',
                imagePath: './images/drawings/house.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-12',
                title: 'Bicycle',
                keyword: 'movement',
                imagePath: './images/drawings/bicycle.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-13',
                title: 'Car',
                keyword: 'speed',
                imagePath: './images/drawings/car.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-14',
                title: 'Train',
                keyword: 'momentum',
                imagePath: './images/drawings/train.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-15',
                title: 'Plane',
                keyword: 'holiday',
                imagePath: './images/drawings/plane.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-16',
                title: 'Rocket',
                keyword: 'space',
                imagePath: './images/drawings/rocket.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-17',
                title: 'Television',
                keyword: 'visual',
                imagePath: './images/drawings/tv.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-18',
                title: 'Phone',
                keyword: 'communicate',
                imagePath: './images/drawings/phone.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-19',
                title: 'Book',
                keyword: 'literature',
                imagePath: './images/drawings/book.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-20',
                title: 'Wine Glass',
                keyword: 'drink',
                imagePath: './images/drawings/glass.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-21',
                title: 'Pencil',
                keyword: 'artistic',
                imagePath: './images/drawings/pencil.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-22',
                title: 'Padlock',
                keyword: 'security',
                imagePath: './images/drawings/padlock.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-23',
                title: 'Clock',
                keyword: 'time',
                imagePath: './images/drawings/clock.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-24',
                title: 'Knife',
                keyword: 'sharp',
                imagePath: './images/drawings/knife.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-25',
                title: 'Gun',
                keyword: 'dangerous',
                imagePath: './images/drawings/gun.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-26',
                title: 'Tree',
                keyword: 'natural',
                imagePath: './images/drawings/tree.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-27',
                title: 'Flower',
                keyword: 'organic',
                imagePath: './images/drawings/flower.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-28',
                title: 'Moon',
                keyword: 'night',
                imagePath: './images/drawings/moon.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-29',
                title: 'Rain',
                keyword: 'weather',
                imagePath: './images/drawings/rain.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-30',
                title: 'Lightning',
                keyword: 'powerful',
                imagePath: './images/drawings/lightning.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-31',
                title: 'Dog',
                keyword: 'loyal',
                imagePath: './images/drawings/dog.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-32',
                title: 'Fish',
                keyword: 'underwater',
                imagePath: './images/drawings/fish.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-33',
                title: 'Bird',
                keyword: 'sky',
                imagePath: './images/drawings/bird.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-34',
                title: 'Alien',
                keyword: 'weird',
                imagePath: './images/drawings/alien.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-35',
                title: 'Ghost',
                keyword: 'spooky',
                imagePath: './images/drawings/ghost.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-36',
                title: 'Skull',
                keyword: 'morbid',
                imagePath: './images/drawings/skull.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-37',
                title: 'Scribble',
                keyword: 'nothing',
                imagePath: './images/drawings/scribble.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-38',
                title: 'NO',
                keyword: 'negative',
                imagePath: './images/drawings/no.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-39',
                title: 'Penis',
                keyword: 'naughty',
                imagePath: './images/drawings/penis.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            },
            {
                id: 'default-40',
                title: 'Offensive',
                keyword: 'offensive',
                imagePath: './images/drawings/offensive.png',
                created: '2024-03-22T11:35:00.000Z',
                lastModified: '2024-03-22T11:35:00.000Z'
            }
        ];

        // Initialize drawings from localStorage and merge with defaults
        function initializeDrawings() {
            const userDrawings = JSON.parse(localStorage.getItem('drawings') || '[]');
            
            // Filter out any default drawings that might have been saved
            const filteredUserDrawings = userDrawings.filter(drawing => 
                !drawing.id.startsWith('default-')
            );
            
            // Merge default drawings with user drawings
            drawings = [...defaultDrawings, ...filteredUserDrawings];
            
            // Save the merged list back to localStorage
            localStorage.setItem('drawings', JSON.stringify(drawings));
            
            updateDrawingsList();
        }

        // Call initializeDrawings when the page loads
        initializeDrawings();

        // Modify the delete function to prevent deleting default drawings
        function deleteDrawing() {
            if (!drawingToDelete) return;
            
            // Check if trying to delete a default drawing
            if (drawingToDelete.startsWith('default-')) {
                alert('Default drawings cannot be deleted');
                hideDeletePopup();
                return;
            }
            
            drawings = drawings.filter(d => d.id !== drawingToDelete);
            localStorage.setItem('drawings', JSON.stringify(drawings));
            updateDrawingsList();
            hideDeletePopup();
        }

        // Update the drawing list to show a lock icon for default drawings
        function updateDrawingsList() {
            const drawingList = document.getElementById('drawing-list');
            if (!drawingList) return;

            // Create a container for the two-column layout with minimal spacing
            drawingList.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 0 4px;">
                    ${drawings
                        .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                        .map(drawing => `
                            <div class="drawing-item" style="display: flex; align-items: center; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05); color: #e8eaed;">
                                <span style="flex: 1; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${drawing.title.toUpperCase()} - ${drawing.keyword.toUpperCase()}</span>
                                <button class="edit-drawing-btn" style="background: none; border: none; color: #007AFF; padding: 2px; margin-left: 4px; font-size: 10px; cursor: pointer;" data-id="${drawing.id}">EDIT</button>
                            </div>
                        `).join('')}
                </div>`;

            // Add click handlers to edit buttons
            document.querySelectorAll('.edit-drawing-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const drawingId = button.dataset.id;
                    const drawing = drawings.find(d => d.id === drawingId);
                    if (drawing && drawing.imagePath) {
                        loadDrawing(drawing.imagePath);
                        settingsPanel.classList.remove('active');
                    }
                });
            });
        }

        // Drawing functionality
        let canvas, ctx, isDrawing = false, lastX = 0, lastY = 0, lastTapTime = 0;

        function resizeCanvas() {
            if (!canvas) return;
            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            tempCtx.drawImage(canvas, 0, 0);
            
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Restore drawing settings
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
            
            // Restore the drawing
            ctx.drawImage(tempCanvas, 0, 0);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            let x, y;
            
            if (e.type === 'mousemove') {
                x = e.clientX - rect.left;
                y = e.clientY - rect.top;
            } else if (e.type === 'touchmove') {
                x = e.touches[0].clientX - rect.left;
                y = e.touches[0].clientY - rect.top;
            }

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        function startDrawing(e) {
            isDrawing = true;
            e.preventDefault();
            
            const rect = canvas.getBoundingClientRect();
            if (e.type === 'mousedown') {
                lastX = e.clientX - rect.left;
                lastY = e.clientY - rect.top;
            } else if (e.type === 'touchstart') {
                lastX = e.touches[0].clientX - rect.left;
                lastY = e.touches[0].clientY - rect.top;
            }
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                saveDrawingState();
            }
        }

        function initializeDrawing() {
            canvas = document.getElementById('drawing-canvas');
            if (!canvas) return;

            ctx = canvas.getContext('2d');
            
            // Set initial canvas size
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;

            // Drawing settings
            ctx.strokeStyle = '#FFFFFF';
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;

            // Remove any existing listeners
            canvas.removeEventListener('mousedown', startDrawing);
            canvas.removeEventListener('mousemove', draw);
            canvas.removeEventListener('mouseup', stopDrawing);
            canvas.removeEventListener('mouseout', stopDrawing);
            canvas.removeEventListener('touchstart', startDrawing);
            canvas.removeEventListener('touchmove', draw);
            canvas.removeEventListener('touchend', stopDrawing);

            // Add event listeners for drawing
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // Handle window resize
            window.removeEventListener('resize', resizeCanvas);
            window.addEventListener('resize', resizeCanvas);

            // Initialize drawing history
            drawingHistory = [canvas.toDataURL()];
            currentHistoryIndex = 0;

            const undoButton = document.querySelector('.circle-button:first-child');
            
            // Setup undo button with both click and hold functionality
            undoButton.addEventListener('mousedown', () => {
                undoPressTimer = setTimeout(() => {
                    clearCanvas();
                }, 500); // Clear canvas after 500ms hold
            });

            undoButton.addEventListener('mouseup', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                    if (!undoButton.classList.contains('disabled')) {
                        undo();
                    }
                }
            });

            undoButton.addEventListener('mouseleave', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                }
            });

            // Touch events for undo button
            undoButton.addEventListener('touchstart', () => {
                undoPressTimer = setTimeout(() => {
                    clearCanvas();
                }, 500);
            });

            undoButton.addEventListener('touchend', () => {
                if (undoPressTimer) {
                    clearTimeout(undoPressTimer);
                    if (!undoButton.classList.contains('disabled')) {
                        undo();
                    }
                }
            });
        }

        // Save drawing functionality
        function showDrawingPopup(isEditing = false, drawingId = null) {
            isEditingDrawing = isEditing;
            editingDrawingId = drawingId;
            
            if (isEditing) {
                const drawing = drawings.find(d => d.id === drawingId);
                drawingTitle.value = drawing.title;
                drawingKeyword.value = drawing.keyword;
            } else {
                drawingTitle.value = '';
                drawingKeyword.value = '';
            }
            
            drawingPopup.classList.add('active');
            drawingTitle.focus();
        }

        function hideDrawingPopup() {
            drawingPopup.classList.remove('active');
            isEditingDrawing = false;
            editingDrawingId = null;
        }

        function saveDrawing() {
            const title = drawingTitle.value.trim();
            const keyword = drawingKeyword.value.trim().toLowerCase();
            
            if (!title || !keyword) {
                alert('Please enter both title and keyword');
                return;
            }

            const drawingData = canvas.toDataURL();
            
            if (isEditingDrawing) {
                const index = drawings.findIndex(d => d.id === editingDrawingId);
                drawings[index] = {
                    ...drawings[index],
                    title,
                    keyword,
                    data: drawingData,
                    lastModified: new Date().toISOString()
                };
            } else {
                drawings.push({
                    id: Date.now().toString(),
                    title,
                    keyword,
                    data: drawingData,
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                });
            }

            localStorage.setItem('drawings', JSON.stringify(drawings));
            updateDrawingsList();
            hideDrawingPopup();
        }

        function showDeletePopup(drawingId) {
            drawingToDelete = drawingId;
            deletePopup.classList.add('active');
        }

        function hideDeletePopup() {
            deletePopup.classList.remove('active');
            drawingToDelete = null;
        }

        function saveDrawingState() {
            if (currentHistoryIndex < drawingHistory.length - 1) {
                drawingHistory = drawingHistory.slice(0, currentHistoryIndex + 1);
            }
            drawingHistory.push(canvas.toDataURL());
            currentHistoryIndex++;
            
            // Enable/disable undo button based on history
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.toggle('disabled', currentHistoryIndex <= 0);
        }

        function undo() {
            if (currentHistoryIndex <= 0) return;
            
            currentHistoryIndex--;
            const img = new Image();
            img.onload = function() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = drawingHistory[currentHistoryIndex];

            // Update undo button state
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.toggle('disabled', currentHistoryIndex <= 0);
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawingHistory = [canvas.toDataURL()];
            currentHistoryIndex = 0;
            
            // Disable undo button after clear
            const undoButton = document.querySelector('.circle-button:first-child');
            undoButton.classList.add('disabled');
        }

        // Voice activation functionality
        let countdownTimer;
        
        function startCountdown() {
            let count = 10;
            countdownDisplay.textContent = count;
            countdownDisplay.classList.add('active');
            
            countdownTimer = setInterval(() => {
                count--;
                countdownDisplay.textContent = count;
                
                if (count === 0) {
                    clearInterval(countdownTimer);
                    countdownDisplay.classList.remove('active');
                    startVoiceRecognition();
                }
            }, 1000);
        }

        function startVoiceRecognition() {
            try {
                recognition.start();
            } catch (err) {
                console.log('Error starting recognition:', err);
                microphoneActive = false;
                countdownDisplay.classList.remove('active');
            }
        }

        // Speech Recognition Setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let micStartTimeout;
        let microphoneActive = false;
        const startMicButton = document.getElementById('start-mic');
        const micToggle = document.getElementById('mic-toggle');

        // Initialize Speech Recognition if available
        try {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            // Try to suppress the beep sound
            recognition.soundstart = null;
            recognition.soundend = null;
            recognition.audiostart = null;
            recognition.audioend = null;

            // Additional settings to try to minimize system sounds
            if (typeof recognition.volume !== 'undefined') recognition.volume = 0;
            if (typeof recognition.enableBeep !== 'undefined') recognition.enableBeep = false;

            // Speech recognition event handling
            recognition.onstart = () => {
                // Attempt to play a silent audio to override system beep
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    oscillator.frequency.value = 0;
                    oscillator.connect(audioContext.destination);
                    oscillator.start(0);
                    oscillator.stop(0.001);
                } catch (e) {
                    // Silently handle any audio context errors
                }
            };

            recognition.onresult = (event) => {
                const current = event.resultIndex;
                const transcript = event.results[current][0].transcript.toLowerCase();
                
                // Only use speech recognition for the order effect
                if (currentEffect !== 'pen' && transcript.includes(triggerWord.value.toLowerCase())) {
                    const itemOrder = extractItemOrder(transcript);
                    if (itemOrder.length === 4) {
                        updateResponseText(itemOrder);
                        microphoneActive = false;
                        recognition.stop();
                    }
                }
            };

            recognition.onend = () => {
                // Only restart if still active and in the correct mode
                if (microphoneActive) {
                    try {
                        recognition.start();
                    } catch (err) {
                        // Silently handle any errors when restarting recognition
                    }
                }
            };

            recognition.onerror = (event) => {
                console.log('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    microphoneActive = false;
                    countdownDisplay.classList.remove('active');
                }
            };
        } catch (err) {
            console.log('Speech Recognition not available');
        }

        // Store the original items
        const items = {
            'phone': 'a phone',
            'watch': 'a watch',
            'airpods': 'Airpods',
            'wallet': 'a wallet'
        };

        // Settings Panel Functionality
        settingsButton.addEventListener('click', () => {
            settingsPanel.classList.add('active');
            loadFreeWillSettings();
        });
        
        // Load Free Will settings into the form
        function loadFreeWillSettings() {
            const savedInputMethod = localStorage.getItem('freewill-input-method') || 'columns';
            const savedColumns = localStorage.getItem('freewill-columns') || '3';
            
            // Set the radio button
            const radioButtons = document.querySelectorAll('input[name="freewill-input-method"]');
            radioButtons.forEach(radio => {
                if (radio.value === savedInputMethod) {
                    radio.checked = true;
                }
            });
            
            // Set the columns input
            document.getElementById('freewill-columns').value = savedColumns;
        }

        closeSettings.addEventListener('click', () => {
            settingsPanel.classList.remove('active');
        });

        // Mic Toggle Functionality
        micToggle.addEventListener('click', () => {
            if (currentEffect === 'pen') {
                // Show and focus the hidden input for dictation
                const dictationInput = document.getElementById('dictation-input');
                dictationInput.value = ''; // Clear previous input
                dictationInput.style.position = 'fixed';
                dictationInput.style.top = '50%';
                dictationInput.style.left = '50%';
                dictationInput.style.transform = 'translate(-50%, -50%)';
                dictationInput.style.width = '80%';
                dictationInput.style.height = '40px';
                dictationInput.style.fontSize = '16px';
                dictationInput.style.padding = '8px';
                dictationInput.style.border = 'none';
                dictationInput.style.background = 'black';
                dictationInput.style.color = 'black';
                dictationInput.style.caretColor = 'transparent';
                dictationInput.focus();
            } else {
                // Original microphone functionality for other modes
                microphoneActive = false;
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {
                    // Silently handle any errors when stopping recognition
                }
                startMicButton.style.color = '#FFB800';
                startMicButton.style.borderColor = '#FFB800';
                startMicButton.disabled = false;
            }
        });

        // Start Mic Button Functionality
        startMicButton.addEventListener('click', () => {
            if (currentEffect === 'pen') {
                showDrawingPopup();
            } else if (currentEffect === 'new') {
                // Reset the Free Will effect
                textOverlay.innerHTML = `<h1 class="notes-title" contenteditable="true" spellcheck="true">Free Will</h1>
                    <br><br>
                    Infront of you, you should have 3 items:
                    <br><br>
                    A pen<br>
                    A wallet<br>
                    A watch
                    <br><br>
                    Pick up one and give it to me.`;
                initializeFreeWill();
            } else {
                // Original microphone functionality
                microphoneActive = true;
                startMicrophoneAfterDelay();
                startMicButton.style.color = '#666';
                startMicButton.style.borderColor = '#666';
                startMicButton.disabled = true;
            }
        });

        // Settings Input Listeners
        micDelay.addEventListener('change', () => {
            if (microphoneActive) {
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {}
                startMicrophoneAfterDelay();
            }
        });

        triggerWord.addEventListener('change', () => {
            if (microphoneActive) {
                clearTimeout(micStartTimeout);
                try {
                    recognition.stop();
                } catch (err) {}
                startMicrophoneAfterDelay();
            }
        });

        function startMicrophoneAfterDelay() {
            if (!microphoneActive) return;
            
            const delay = parseInt(micDelay.value) * 1000;
            micStartTimeout = setTimeout(() => {
                if (!microphoneActive) {
                    startMicButton.style.color = '#FFB800';
                    startMicButton.style.borderColor = '#FFB800';
                    startMicButton.disabled = false;
                    return;
                }
                try {
                    recognition.start();
                } catch (err) {
                    // Silently handle any errors when starting recognition
                }
            }, delay);
        }

        // Initialize with Free Will effect
        switchToEffect('new');

        // Free Will functionality
        function initializeFreeWill() {
            const textOverlay = document.getElementById('text-overlay');
            const items = JSON.parse(localStorage.getItem('freewill-items')) || ['A pen', 'A wallet', 'A watch'];
            let scrollCount = 0;
            let selectedItems = [];
            let startY = 0;
            let startX = 0;
            let lastScrollTop = 0;

            // Load saved messages from localStorage
            const firstMessage = localStorage.getItem('freewill-first') || 'Great. Now pick up another item and put it in your pocket.';
            const secondMessage = localStorage.getItem('freewill-second') || 'Perfect. And the last item, keep in your hands.';
            const finalTemplate = localStorage.getItem('freewill-final') || 'If I have influenced you correctly, I should be holding the [FIRST], you should be holding the [LAST], and the [SECOND] should be in your pocket!';
            
            // Load saved input method and columns
            const inputMethod = localStorage.getItem('freewill-input-method') || 'columns';
            const columns = parseInt(localStorage.getItem('freewill-columns')) || 3;

            // Initial content with spacing
            const spacer = '<br>'.repeat(100);
            textOverlay.innerHTML = `<h1 class="notes-title">Free Will</h1>
                <br><br>
                Infront of you, you should have ${items.length} items:
                <br><br>
                ${items.join('<br>')}
                <br><br>
                Pick up one and give it to me.${spacer}`;

            function getColumnFromX(x) {
                const width = window.innerWidth;
                const columnWidth = width / columns;
                return Math.floor(x / columnWidth);
            }

            function addItemToSelection(itemIndex) {
                if (scrollCount >= 2) return;
                const item = items[itemIndex];
                
                if (!selectedItems.includes(item)) {
                    selectedItems.push(item);
                    scrollCount++;

                    // Generate new text based on scroll count
                    if (scrollCount === 1) {
                        // Update time display as visual indicator for first input
                        let timeDisplay = '22 March 2025 at 11:35'; // Default
                        if (inputMethod === 'direction') {
                            if (itemIndex === 0) timeDisplay = '22 March 2025 at 11:15'; // ONE
                            else if (itemIndex === 1) timeDisplay = '22 March 2025 at 11:25'; // TWO
                            else if (itemIndex === 2) timeDisplay = '22 March 2025 at 11:35'; // THREE
                        }
                        document.querySelector('.creation-time').textContent = timeDisplay;
                        
                        textOverlay.innerHTML += firstMessage + spacer;
                    } else if (scrollCount === 2) {
                        const unscrolledItem = items.find(item => !selectedItems.includes(item));
                        const finalMessage = finalTemplate
                            .replace('[FIRST]', selectedItems[0].replace('A ', ''))
                            .replace('[SECOND]', selectedItems[1].replace('A ', ''))
                            .replace('[LAST]', unscrolledItem.replace('A ', ''));
                        
                        textOverlay.innerHTML += secondMessage + spacer + finalMessage;
                    }
                }
            }

            // For first input: use Direction or Columns based on settings
            // For second input: always use Columns
            if (inputMethod === 'direction' && scrollCount === 0) {
                // Direction input method for first swipe
                let faceDownTimer = null;
                let phoneFaceDown = false;
                let waitingForTurnUp = false;
                let turnTimer = null;
                let lastBeta = null;
                let hasTapped = false;
                let faceDownTime = null;
                
                // Listen for device orientation
                window.addEventListener('deviceorientation', (event) => {
                    const beta = event.beta; // Rotation around x-axis (-180 to 180)
                    const gamma = event.gamma; // Rotation around y-axis (-90 to 90)
                    const alpha = event.alpha; // Rotation around z-axis (0-360, compass)
                    
                    console.log(`Beta: ${beta.toFixed(1)}, Gamma: ${gamma.toFixed(1)}, Alpha: ${alpha.toFixed(1)}`);
                    
                    // Detect face down: beta close to 180 or -180, gamma close to 0
                    const isFaceDown = (Math.abs(beta) > 140 && Math.abs(gamma) < 30);
                    
                    // Phone is face down - start 1 second timer
                    if (isFaceDown && !phoneFaceDown && faceDownTimer === null) {
                        faceDownTimer = setTimeout(() => {
                            phoneFaceDown = true;
                            waitingForTurnUp = true;
                            faceDownTime = Date.now();
                            console.log('Phone face down for 1 second - waiting for turn up');
                        }, 1000);
                    }
                    
                    // Phone moved away from face down - cancel timer if we haven't confirmed yet
                    if (!isFaceDown && faceDownTimer !== null && !phoneFaceDown) {
                        clearTimeout(faceDownTimer);
                        faceDownTimer = null;
                        console.log('Phone moved before 1 second - cancelled');
                    }
                    
                    // Detect if phone is being turned back up
                    if (phoneFaceDown && !isFaceDown && waitingForTurnUp) {
                        phoneFaceDown = false;
                        waitingForTurnUp = false;
                        const turnDirection = gamma > 20 ? 'right-to-left' : 'left-to-right';
                        console.log(`Phone turned up: ${turnDirection}`);
                        
                        // Start 5 second timer when phone starts turning
                        hasTapped = false;
                        turnTimer = setTimeout(() => {
                            // Timer ended without tap, input based on direction
                            if (!hasTapped) {
                                if (turnDirection === 'left-to-right') {
                                    console.log('No tap, left-to-right - Input ONE');
                                    addItemToSelection(0);
                                } else {
                                    console.log('No tap, right-to-left - Input TWO');
                                    addItemToSelection(1);
                                }
                            }
                            turnTimer = null;
                        }, 5000);
                    }
                    
                    lastBeta = beta;
                });
                
                // Listen for tap on screen (for THREE input)
                const handleTouchStart = (e) => {
                    // Check if timer is active (for THREE input)
                    if (turnTimer !== null && scrollCount === 0) {
                        hasTapped = true;
                        clearTimeout(turnTimer);
                        turnTimer = null;
                        console.log('Tap detected - Input THREE');
                        addItemToSelection(2);
                        return;
                    }
                    
                    // Track for swipes after first input
                    if (scrollCount > 0) {
                        startY = e.touches[0].clientY;
                        startX = e.touches[0].clientX;
                    }
                };
                
                textOverlay.addEventListener('touchstart', handleTouchStart);
                
                // Add touchmove for second swipe (columns method)
                textOverlay.addEventListener('touchmove', (e) => {
                    if (scrollCount === 0) {
                        // First swipe uses direction method
                        return;
                    }
                    
                    const touch = e.touches[0];
                    const deltaY = touch.clientY - startY;
                    const deltaX = touch.clientX - startX;

                    // Only trigger if it's a vertical swipe (up)
                    if (deltaY < -50 && Math.abs(deltaX) < Math.abs(deltaY)) {
                        const column = getColumnFromX(touch.clientX);
                        addItemToSelection(column);
                    }
                });
                
            } else {
                // Columns input method for first swipe
                textOverlay.addEventListener('touchstart', (e) => {
                    startY = e.touches[0].clientY;
                    startX = e.touches[0].clientX;
                });

                textOverlay.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const deltaY = touch.clientY - startY;
                    const deltaX = touch.clientX - startX;

                    // Only trigger if it's a vertical swipe (up)
                    if (deltaY < -50 && Math.abs(deltaX) < Math.abs(deltaY)) {
                        const column = getColumnFromX(touch.clientX);
                        addItemToSelection(column);
                    }
                });
            }

            // Track scroll position
            textOverlay.addEventListener('scroll', () => {
                const currentScrollTop = textOverlay.scrollTop;
                const scrollDelta = currentScrollTop - lastScrollTop;
                lastScrollTop = currentScrollTop;
            });
        }

        // Save Free Will settings
        document.getElementById('save-freewill').addEventListener('click', () => {
            const items = document.getElementById('freewill-items').value.split('\n').filter(item => item.trim());
            const firstMessage = document.getElementById('freewill-first').value;
            const secondMessage = document.getElementById('freewill-second').value;
            const finalTemplate = document.getElementById('freewill-final').value;
            
            const selectedInputMethod = document.querySelector('input[name="freewill-input-method"]:checked').value;
            const columns = parseInt(document.getElementById('freewill-columns').value);

            localStorage.setItem('freewill-items', JSON.stringify(items));
            localStorage.setItem('freewill-first', firstMessage);
            localStorage.setItem('freewill-second', secondMessage);
            localStorage.setItem('freewill-final', finalTemplate);
            localStorage.setItem('freewill-input-method', selectedInputMethod);
            localStorage.setItem('freewill-columns', columns);

            // Show feedback
            const saveButton = document.getElementById('save-freewill');
            saveButton.textContent = 'Saved!';
            setTimeout(() => {
                saveButton.textContent = 'Save Changes';
            }, 2000);
        });

        // Function to extract item order from speech
        function extractItemOrder(transcript) {
            const lowerTranscript = transcript.toLowerCase();
            const itemOrder = [];
            
            Object.keys(items).forEach(item => {
                const index = lowerTranscript.indexOf(item);
                if (index !== -1) {
                    itemOrder.push({
                        item: item,
                        index: index
                    });
                }
            });

            // Sort by position in transcript
            itemOrder.sort((a, b) => a.index - b.index);
            return itemOrder.map(item => item.item);
        }

        // Function to update the response text
        function updateResponseText(itemOrder) {
            const textOverlay = document.getElementById('text-overlay');
            const template = responseTemplate.value;
            
            let response = template
                .replace('[ITEM 1]', items[itemOrder[0]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 2]', items[itemOrder[1]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 3]', items[itemOrder[2]].replace('a ', 'the ').replace('an ', 'the '))
                .replace('[ITEM 4]', items[itemOrder[3]].replace('a ', 'the ').replace('an ', 'the '));

            // Split content at the last visible paragraph
            const content = textOverlay.innerHTML.split('Place these items in any order you wish.');
            
            // Update the hidden paragraph with many line breaks before it
            textOverlay.innerHTML = content[0] + 'Place these items in any order you wish.' + '<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>' + response;
        }

        // Add event listeners for drawing popup
        document.getElementById('save-drawing').addEventListener('click', saveDrawing);
        document.getElementById('cancel-drawing').addEventListener('click', hideDrawingPopup);
        
        // Add event listeners for delete popup
        cancelDeleteBtn.addEventListener('click', hideDeletePopup);
        confirmDeleteBtn.addEventListener('click', deleteDrawing);

        // Effect switching functions
        function switchToEffect(effect) {
            console.log('switchToEffect called with:', effect); // Debug log
            currentEffect = effect;
            
            // Hide all settings panels first
            document.querySelectorAll('.effect-settings').forEach(panel => {
                panel.style.display = 'none';
            });

            // Reset UI elements
            const undoButton = document.querySelector('.circle-button:first-child');
            const redoButton = document.querySelector('.circle-button:last-child');
            undoButton.classList.add('disabled');
            redoButton.classList.add('disabled');

            // Set static creation time
            document.querySelector('.creation-time').textContent = '22 March 2025 at 11:35';

            // Reset canvas and text overlay visibility
            drawingCanvas.style.display = 'none';
            textOverlay.style.display = 'block';
            
            // Reset numpad and filtered words containers
            const numpadContainer = document.getElementById('numpad-container');
            const filteredWordsContainer = document.getElementById('filtered-words');
            
            if (numpadContainer) numpadContainer.style.display = 'none';
            if (filteredWordsContainer) filteredWordsContainer.style.display = 'none';

            // Effect-specific changes
            switch(effect) {
                case 'writing':
                    console.log('Setting up writing effect'); // Debug log
                    document.getElementById('other-settings').style.display = 'block';
                    notesTitle.textContent = 'Word Filter';
                    textOverlay.innerHTML = `<h1 class="notes-title">Word Filter</h1>`;
                    
                    // Show numpad
                    if (numpadContainer) {
                        currentCode = '';
                        const numpadDisplay = document.getElementById('numpad-display');
                        if (numpadDisplay) numpadDisplay.textContent = '';
                        numpadContainer.style.display = 'block';
                        
                        // Load word list
                        fetch('data/Long_Nouns.txt')
                            .then(response => response.text())
                            .then(text => {
                                window.wordList = text.split('\n')
                                    .map(word => word.trim())
                                    .filter(word => word.length > 0);
                                console.log('Word list loaded:', window.wordList.length, 'words'); // Debug log
                            })
                            .catch(error => console.error('Error loading word list:', error));
                    }
                    break;
                    
                case 'order':
                    document.getElementById('order-settings').style.display = 'block';
                    notesTitle.textContent = 'Items';
                    textOverlay.innerHTML = `<h1 class="notes-title">Items</h1>
                        <br>
                        Infront of you are 4 items:
                        <br><br>
                        A phone<br>
                        A watch<br>
                        Airpods<br>
                        A wallet
                        <br><br>
                        Place these items in any order you wish.
                        <br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>`;
                    break;
                    
                case 'new':
                    document.getElementById('freewill-settings').style.display = 'block';
                    notesTitle.textContent = 'Free Will';
                    textOverlay.innerHTML = `<h1 class="notes-title">Free Will</h1>
                        <br><br>
                        Infront of you, you should have 3 items:
                        <br><br>
                        A pen<br>
                        A wallet<br>
                        A watch
                        <br><br>
                        Pick up one and give it to me.`;
                    initializeFreeWill();
                    break;
                    
                case 'paperclip':
                    document.getElementById('other-settings').style.display = 'block';
                    notesTitle.textContent = 'Billet?';
                    textOverlay.innerHTML = `<h1 class="notes-title">Billet?</h1>`;
                    break;
                    
                case 'pen':
                    document.getElementById('drawing-settings').style.display = 'block';
                    notesTitle.textContent = 'Drawing';
                    textOverlay.style.display = 'none';
                    drawingCanvas.style.display = 'block';
                    initializeDrawing();
                    undoButton.classList.remove('disabled');
                    break;
                    
                default:
                    document.getElementById('other-settings').style.display = 'block';
                    notesTitle.textContent = 'Error';
                    textOverlay.innerHTML = `<h1 class="notes-title">Error</h1>`;
            }
        }

        // Function to load a drawing onto the canvas
        function loadDrawing(imagePath) {
            // Switch to pen effect if not already there
            if (currentEffect !== 'pen') {
                switchToEffect('pen');
            }
            
            // Ensure canvas is visible and properly sized
            drawingCanvas.style.display = 'block';
            textOverlay.style.display = 'none';
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Load the drawing
            const img = new Image();
            img.onload = function() {
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Set white stroke style for visibility
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 3;
                
                // Draw the image centered on the canvas
                const scale = Math.min(
                    canvas.width / img.width,
                    canvas.height / img.height
                );
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                
                // Save this state in drawing history
                drawingHistory = [canvas.toDataURL()];
                currentHistoryIndex = 0;
            };
            img.src = imagePath;
        }

        // Add click event listener to close save popup when clicking outside
        document.addEventListener('click', function(event) {
            const savePopup = document.getElementById('save-popup');
            const saveButton = document.getElementById('save-button');
            
            // Check if save popup is visible and click is outside the popup and not on the save button
            if (savePopup && 
                savePopup.style.display === 'flex' && 
                !savePopup.contains(event.target) && 
                event.target !== saveButton) {
                savePopup.style.display = 'none';
            }
        });

        // Modify the showSavePopup function to prevent immediate closure
        function showSavePopup() {
            const savePopup = document.getElementById('save-popup');
            savePopup.style.display = 'flex';
            
            // Prevent the click event from immediately closing the popup
            event.stopPropagation();
        }

        // Add input event listener for the dictation input
        document.getElementById('dictation-input').addEventListener('input', (event) => {
            if (currentEffect !== 'pen') return;

            const transcript = event.target.value.toLowerCase();
            const matchingDrawing = drawings.find(d => transcript.includes(d.keyword.toLowerCase()));
            
            if (matchingDrawing) {
                // Hide the input and clear its value
                event.target.style.position = 'absolute';
                event.target.style.top = '-9999px';
                event.target.style.left = '-9999px';
                event.target.value = '';
                event.target.blur();

                // Load the matching drawing
                loadDrawing(matchingDrawing.imagePath);
            }
        });

        // Add blur event listener to hide the input when keyboard is dismissed
        document.getElementById('dictation-input').addEventListener('blur', (event) => {
            event.target.style.position = 'absolute';
            event.target.style.top = '-9999px';
            event.target.style.left = '-9999px';
            event.target.value = '';
        });

        // Letter shape categories
        const letterShapes = {
            straight: ['A', 'E', 'F', 'H', 'I', 'K', 'L', 'M', 'N', 'T', 'V', 'W', 'X', 'Y', 'Z'],
            mixed: ['B', 'D', 'G', 'J', 'P', 'Q', 'R', 'U', 'W', 'Y'],
            curved: ['C', 'G', 'J', 'O', 'Q', 'S', 'U', 'W']
        };

        // Initialize numpad functionality
        let currentCode = '';
        const numpadDisplay = document.getElementById('numpad-display');
        const numpadContainer = document.getElementById('numpad-container');
        const filteredWordsContainer = document.getElementById('filtered-words');

        // Add click handlers to numpad buttons
        document.querySelectorAll('.numpad-btn').forEach(button => {
            button.addEventListener('click', () => {
                if (button.classList.contains('backspace')) {
                    // Handle backspace
                    currentCode = currentCode.slice(0, -1);
                    numpadDisplay.textContent = currentCode;
                } else if (currentCode.length < 4 && button.textContent) {
                    currentCode += button.textContent;
                    numpadDisplay.textContent = currentCode;

                    if (currentCode.length === 4) {
                        // Check for special code "1234"
                        if (currentCode === "1234") {
                            // Show settings panel
                            document.getElementById('writing-settings').style.display = 'block';
                            // Clear the code
                            setTimeout(() => {
                                currentCode = '';
                                numpadDisplay.textContent = '';
                            }, 500);
                        } else {
                            // Normal word filtering
                            setTimeout(() => {
                                numpadContainer.style.display = 'none';
                                filterWords(currentCode);
                            }, 500);
                        }
                    }
                }
            });
        });

        // Function to determine letter shape
        function getLetterShape(letter) {
            const straight = ['A', 'E', 'F', 'H', 'I', 'K', 'L', 'M', 'N', 'T', 'V', 'W', 'X', 'Y', 'Z'];
            const mixed = ['B', 'D', 'G', 'J', 'P', 'Q', 'R', 'U', 'W', 'Y'];
            const curved = ['C', 'G', 'J', 'O', 'Q', 'S', 'U', 'W'];
            
            letter = letter.toUpperCase();
            if (straight.includes(letter)) return 1;
            if (mixed.includes(letter)) return 2;
            if (curved.includes(letter)) return 3;
            return 0; // Default case
        }

        // Function to find vowel positions
        function getVowelPositions(word) {
            const vowels = ['A', 'E', 'I', 'O', 'U'];
            const positions = [];
            for (let i = 0; i < word.length; i++) {
                if (vowels.includes(word[i].toUpperCase())) {
                    positions.push(i + 1); // 1-based position
                }
            }
            return positions;
        }

        // Function to filter words based on code
        function filterWords(code) {
            if (!window.wordList) {
                console.error('Word list not loaded');
                return;
            }

            const length = parseInt(code[0]);
            const firstVowelPos = parseInt(code[1]);
            const secondVowelPos = parseInt(code[2]);
            const firstLetterShape = parseInt(code[3]);

            const filteredWords = window.wordList.filter(word => {
                // Check word length
                if (word.length !== length) return false;

                // Get vowel positions
                const vowelPositions = getVowelPositions(word);
                
                // Check first vowel position
                if (vowelPositions[0] !== firstVowelPos) return false;

                // Check second vowel position if specified
                if (secondVowelPos > 0 && (!vowelPositions[1] || vowelPositions[1] !== secondVowelPos)) return false;

                // Check first letter shape
                const firstLetter = word[0].toUpperCase();
                const shape = getLetterShape(firstLetter);
                if (shape !== firstLetterShape) return false;

                return true;
            });

            // Analyze differences at each position
            const positionDifferences = [];
            for (let pos = 0; pos < length; pos++) {
                const lettersAtPosition = new Set(filteredWords.map(word => word[pos].toUpperCase()));
                positionDifferences[pos] = lettersAtPosition.size;
            }

            // Find position with most differences
            let maxDiffPosition = 0;
            let maxDiffs = positionDifferences[0];
            for (let i = 1; i < positionDifferences.length; i++) {
                if (positionDifferences[i] > maxDiffs) {
                    maxDiffs = positionDifferences[i];
                    maxDiffPosition = i;
                }
            }

            // Display filtered words with position indicator and lexicon letters
            const filteredWordsContainer = document.getElementById('filtered-words');
            if (filteredWordsContainer) {
                // Get unique letters at the lexicon position
                const lexiconLetters = [...new Set(filteredWords.map(word => word[maxDiffPosition].toUpperCase()))].sort();
                
                filteredWordsContainer.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 24px; color: #FFB800; margin-bottom: 10px;">${maxDiffPosition + 1}</div>
                        <div class="lexicon-letters" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            ${lexiconLetters.map(letter => 
                                `<button class="lexicon-letter" style="background: rgba(255, 184, 0, 0.2); color: #FFB800; border: 1px solid #FFB800; padding: 5px 15px; border-radius: 5px; font-size: 18px; cursor: pointer;">${letter}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="word-list">
                        ${filteredWords.map(word => 
                            `<button class="word" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: inherit;">${word}</button>`
                        ).join('')}
                    </div>
                    <button onclick="document.getElementById('filtered-words').style.display='none'" style="margin-top: 20px; width: 100%; padding: 10px; background: #007AFF; border: none; border-radius: 8px; color: white;">Close</button>
                `;

                // Add click handlers to lexicon letters
                const wordList = document.querySelector('.word-list');
                document.querySelectorAll('.lexicon-letter').forEach(button => {
                    button.addEventListener('click', () => {
                        const selectedLetter = button.textContent;
                        // Filter words that match the selected letter at the lexicon position
                        const filteredByLetter = filteredWords.filter(word => 
                            word[maxDiffPosition].toUpperCase() === selectedLetter
                        );
                        
                        // Update the word list with clickable buttons
                        wordList.innerHTML = filteredByLetter
                            .map(word => 
                                `<button class="word" style="background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-family: inherit; font-size: inherit;">${word}</button>`
                            ).join('');
                            
                        // Update visual state of buttons
                        document.querySelectorAll('.lexicon-letter').forEach(btn => {
                            if (btn === button) {
                                btn.style.background = '#FFB800';
                                btn.style.color = '#000';
                            } else {
                                btn.style.background = 'rgba(255, 184, 0, 0.2)';
                                btn.style.color = '#FFB800';
                            }
                        });

                        // Function to add click handlers to word buttons
                        addWordClickHandlers();
                    });
                });

                // Function to add click handlers to word buttons
                function addWordClickHandlers() {
                    document.querySelectorAll('.word-list .word').forEach(wordButton => {
                        wordButton.addEventListener('click', () => {
                            const selectedWord = wordButton.textContent;
                            // Update iOS title if it exists
                            const notesTitle = document.querySelector('.notes-title');
                            if (notesTitle) {
                                notesTitle.textContent = selectedWord;
                            }
                            // Update Android title if it exists
                            const androidTitle = document.querySelector('#android-ui .note-title');
                            if (androidTitle) {
                                androidTitle.value = selectedWord;
                            }
                            // Hide the filtered words container
                            const filteredWordsContainer = document.getElementById('filtered-words');
                            if (filteredWordsContainer) {
                                filteredWordsContainer.style.display = 'none';
                            }
                        });
                    });
                }

                // Add initial click handlers to word buttons
                addWordClickHandlers();
                
                filteredWordsContainer.style.display = 'block';
            }
        }

        // Platform toggle handler
        document.getElementById('platform-toggle').addEventListener('change', (e) => {
            const isIOS = e.target.checked;
            
            // Toggle Android mode class on body
            document.body.classList.toggle('android-mode', !isIOS);
            
            // Update theme-color meta tag
            const themeColorMeta = document.getElementById('theme-color-meta');
            if (themeColorMeta) {
                themeColorMeta.content = isIOS ? '#000000' : '#202124';
            }
            
            // Save preference
            localStorage.setItem('platform', isIOS ? 'ios' : 'android');
            
            if (isIOS) {
                // Show iOS UI
                document.querySelector('#app').style.display = 'flex';
                document.querySelector('#android-ui').style.display = 'none';
            } else {
                // Show Android UI
                document.querySelector('#app').style.display = 'none';
                document.querySelector('#android-ui').style.display = 'flex';
                
                // Copy current note content to Android UI
                const iosTitle = document.querySelector('.notes-title').textContent;
                const iosContent = document.querySelector('#text-overlay').textContent.replace(iosTitle, '').trim();
                
                const androidTitle = document.querySelector('#android-ui .note-title');
                const androidBody = document.querySelector('#android-ui .note-body');
                
                if (androidTitle) androidTitle.value = iosTitle;
                if (androidBody) androidBody.value = iosContent;

                // Initialize Android UI handlers
                initializeAndroidHandlers();
            }
        });

        // Function to initialize Android UI handlers
        function initializeAndroidHandlers() {
            const androidUI = document.querySelector('#android-ui');
            if (!androidUI) return;

            // Effect triggers
            androidUI.querySelector('.footer img[alt="Color"]').addEventListener('click', () => {
                switchToEffect('pen');
                updateAndroidUIForEffect('pen');
            });

            androidUI.querySelector('.footer img[alt="Add"]').addEventListener('click', () => {
                switchToEffect('writing');
                updateAndroidUIForEffect('writing');
            });

            androidUI.querySelector('.footer img[alt="More"]').addEventListener('click', () => {
                switchToEffect('new');
                updateAndroidUIForEffect('new');
            });

            androidUI.querySelector('.footer-center').addEventListener('click', () => {
                switchToEffect('order');
                updateAndroidUIForEffect('order');
            });

            // Settings trigger
            androidUI.querySelector('.header img[alt="Pin"]').addEventListener('click', () => {
                document.getElementById('settings-panel').classList.add('active');
            });

            // Order mode specific handlers
            androidUI.querySelector('.header img[alt="Back"]').addEventListener('click', () => {
                if (currentEffect === 'order') {
                    microphoneActive = false;
                    clearTimeout(micStartTimeout);
                    try {
                        recognition.stop();
                    } catch (err) {}
                }
            });

            androidUI.querySelector('.header img[alt="Reminder"]').addEventListener('click', () => {
                if (currentEffect === 'order') {
                    microphoneActive = true;
                    startMicrophoneAfterDelay();
                }
            });
        }

        // Function to update Android UI based on current effect
        function updateAndroidUIForEffect(effect) {
            const androidUI = document.querySelector('#android-ui');
            if (!androidUI) return;

            const noteContent = androidUI.querySelector('.note-content');
            
            // Reset all UI elements
            androidUI.querySelector('.note-title').style.display = 'block';
            androidUI.querySelector('.note-body').style.display = 'block';
            androidUI.querySelector('.footer').style.display = 'flex';
            noteContent.classList.remove('free-will-mode');
            
            // Effect-specific UI updates
            switch(effect) {
                case 'pen':
                    // Show canvas, hide text inputs
                    androidUI.querySelector('.note-title').style.display = 'none';
                    androidUI.querySelector('.note-body').style.display = 'none';
                    drawingCanvas.style.display = 'block';
                    break;
                    
                case 'writing':
                    // Show numpad and set correct title/content
                    androidUI.querySelector('.note-title').value = 'Word Filter';
                    androidUI.querySelector('.note-body').value = '';
                    androidUI.querySelector('.note-body').placeholder = ''; // Remove placeholder text
                    if (numpadContainer) {
                        currentCode = '';
                        const numpadDisplay = document.getElementById('numpad-display');
                        if (numpadDisplay) numpadDisplay.textContent = '';
                        numpadContainer.style.display = 'block';
                    }
                    break;
                    
                case 'order':
                    // Update content for order effect
                    androidUI.querySelector('.note-title').value = 'Items';
                    androidUI.querySelector('.note-body').value = `Infront of you are 4 items:

A phone
A watch
Airpods
A wallet

Place these items in any order you wish.`;
                    break;
                    
                case 'new':
                    // Update content for Free Will effect
                    noteContent.classList.add('free-will-mode');
                    androidUI.querySelector('.note-title').value = 'Free Will';
                    androidUI.querySelector('.note-body').value = `Infront of you, you should have 3 items:

A pen
A wallet
A watch

Pick up one and give it to me.`;
                    initializeAndroidFreeWill(androidUI);
                    break;
            }
        }

        // Function to initialize Free Will mode for Android UI
        function initializeAndroidFreeWill(androidUI) {
            const noteContent = androidUI.querySelector('.note-content');
            const noteTitle = androidUI.querySelector('.note-title');
            const noteBody = androidUI.querySelector('.note-body');
            const items = JSON.parse(localStorage.getItem('freewill-items')) || ['A pen', 'A wallet', 'A watch'];
            let scrollCount = 0;
            let selectedItems = [];
            let startY = 0;
            let startX = 0;
            let lastScrollTop = 0;

            // Load saved messages from localStorage
            const firstMessage = localStorage.getItem('freewill-first') || 'Great. Now pick up another item and put it in your pocket.';
            const secondMessage = localStorage.getItem('freewill-second') || 'Perfect. And the last item, keep in your hands.';
            const finalTemplate = localStorage.getItem('freewill-final') || 'If I have influenced you correctly, I should be holding the [FIRST], you should be holding the [LAST], and the [SECOND] should be in your pocket!';

            // Initial content with spacing
            const spacer = '\n'.repeat(100);
            noteTitle.value = 'Free Will';
            noteBody.value = `Infront of you, you should have 3 items:

A pen
A wallet
A watch

Pick up one and give it to me.${spacer}`;

            function getColumnFromX(x) {
                const width = window.innerWidth;
                const columnWidth = width / 3;
                return Math.floor(x / columnWidth);
            }

            function handleSwipe(e) {
                if (scrollCount >= 2) return;

                const touch = e.touches[0];
                const column = getColumnFromX(touch.clientX);
                const item = items[column];

                if (!selectedItems.includes(item)) {
                    selectedItems.push(item);
                    scrollCount++;

                    // Generate new text based on scroll count
                    let newText = '';
                    if (scrollCount === 1) {
                        newText = spacer + firstMessage + spacer;
                    } else if (scrollCount === 2) {
                        const unscrolledItem = items.find(item => !selectedItems.includes(item));
                        const finalMessage = finalTemplate
                            .replace('[FIRST]', selectedItems[0].replace('A ', ''))
                            .replace('[SECOND]', selectedItems[1].replace('A ', ''))
                            .replace('[LAST]', unscrolledItem.replace('A ', ''));
                        
                        newText = spacer + secondMessage + spacer + finalMessage;
                    }

                    // Add the new text to the content
                    noteBody.value += newText;
                }
            }

            // Track scroll position
            noteContent.addEventListener('scroll', () => {
                const currentScrollTop = noteContent.scrollTop;
                const scrollDelta = currentScrollTop - lastScrollTop;
                lastScrollTop = currentScrollTop;
            });

            noteContent.addEventListener('touchstart', (e) => {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
            });

            noteContent.addEventListener('touchmove', (e) => {
                const touch = e.touches[0];
                const deltaY = touch.clientY - startY;
                const deltaX = touch.clientX - startX;

                // Only trigger if it's a vertical swipe (up)
                if (deltaY < -50 && Math.abs(deltaX) < Math.abs(deltaY)) {
                    handleSwipe(e);
                }
            });

            // Enable scrolling on note content
            noteContent.style.overflowY = 'auto';
            noteContent.style.WebkitOverflowScrolling = 'touch';
            noteContent.style.height = '100%';
            noteContent.style.position = 'relative';
            noteBody.style.whiteSpace = 'pre-wrap';
            noteBody.style.overflowY = 'auto';
            noteBody.style.WebkitOverflowScrolling = 'touch';
            noteBody.style.height = '100%';
            noteBody.style.position = 'relative';
        }

        // Initialize platform on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedPlatform = localStorage.getItem('platform');
            const platformToggle = document.getElementById('platform-toggle');
            
            // Set initial theme color based on saved platform
            const themeColorMeta = document.getElementById('theme-color-meta');
            if (themeColorMeta) {
                themeColorMeta.content = (savedPlatform === 'android') ? '#202124' : '#000000';
            }
            
            if (savedPlatform === 'android' && platformToggle) {
                platformToggle.checked = false;
                platformToggle.dispatchEvent(new Event('change'));
            }
            
            // Ensure initial visibility is correct
            const isIOS = platformToggle ? platformToggle.checked : true;
            document.querySelector('#app').style.display = isIOS ? 'flex' : 'none';
            document.querySelector('#android-ui').style.display = isIOS ? 'none' : 'flex';
        });
    </script>
</body>
</html>
